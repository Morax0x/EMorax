const { EmbedBuilder, ActionRowBuilder, ButtonBuilder, ButtonStyle, StringSelectMenuBuilder, ModalBuilder, TextInputBuilder, TextInputStyle, Colors, ComponentType, SlashCommandBuilder } = require("discord.js");
const farmAnimals = require('../../json/farm-animals.json');

const EMOJI_MORA = '<:mora:1435647151349698621>';
const ITEMS_PER_PAGE = 9;

// --- Ø¯ÙˆØ§Ù„ Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¨Ø³ÙŠØ·Ø©) ---

function buildGridView(allItems, pageIndex) {
    const startIndex = pageIndex * ITEMS_PER_PAGE;
    const itemsOnPage = allItems.slice(startIndex, startIndex + ITEMS_PER_PAGE);
    const totalPages = Math.ceil(allItems.length / ITEMS_PER_PAGE);

    const col1 = [], col2 = [], col3 = [];
    itemsOnPage.forEach((item, index) => {
        const price = item.price.toLocaleString();
        const itemLine = `**${item.emoji} ${item.name}**\n${price} ${EMOJI_MORA}`;

        if (index % 3 === 0) col1.push(itemLine);
        else if (index % 3 === 1) col2.push(itemLine);
        else col3.push(itemLine);
    });

    const embed = new EmbedBuilder()
        .setTitle('ðŸžï¸ Ù…ØªØ¬Ø± Ø§Ù„Ù…Ø²Ø±Ø¹Ø©')
        .setColor("Random")
        .setImage('https://i.postimg.cc/J0x0Fj0D/download.gif')
        .setDescription('Ø§Ø®ØªØ± Ø­ÙŠÙˆØ§Ù†Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„Ø´Ø±Ø§Ø¡.')
        .addFields(
            { name: '\u200B', value: col1.join('\n\n') || '\u200B', inline: true },
            { name: '\u200B', value: col2.join('\n\n') || '\u200B', inline: true },
            { name: '\u200B', value: col3.join('\n\n') || '\u200B', inline: true }
        )
        .setFooter({ text: `ØµÙØ­Ø© ${pageIndex + 1}/${totalPages}` });

    const selectOptions = itemsOnPage.map(item => ({
        label: `${item.name}`,
        description: `Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ: ${item.income_per_day} Ù…ÙˆØ±Ø§`,
        value: item.id,
        emoji: item.emoji
    }));

    const selectMenuRow = new ActionRowBuilder().addComponents(
        new StringSelectMenuBuilder()
            .setCustomId('farm_select_item')
            .setPlaceholder('Ø§Ø®ØªØ± Ø­ÙŠÙˆØ§Ù†Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„Ø´Ø±Ø§Ø¡...')
            .addOptions(selectOptions)
    );

    return { embed, components: [selectMenuRow] };
}

function buildDetailView(item, userId, guildId, sql, itemIndex, totalItems) {
    const userFarm = sql.prepare("SELECT COUNT(*) as quantity FROM user_farm WHERE userID = ? AND guildID = ? AND animalID = ?").get(userId, guildId, item.id);
    const userQuantity = userFarm ? userFarm.quantity : 0;
    const price = item.price.toLocaleString();
    const income_per_day = item.income_per_day || 0;
    const lifespan = item.lifespan_days || 30;
    const income = (income_per_day * userQuantity).toLocaleString();

    const detailEmbed = new EmbedBuilder()
        .setTitle(`ðŸžï¸ ${item.name}`)
        .setColor("Random")
        .setThumbnail(item.image || null)
        .addFields(
            { name: 'Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡', value: `${price} ${EMOJI_MORA}`, inline: true },
            { name: 'Ø§Ù„Ø¯Ø®Ù„ (Ù„Ù„ÙŠÙˆÙ…)', value: `${income_per_day} ${EMOJI_MORA}`, inline: true },
            { name: 'Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ', value: `${lifespan} ÙŠÙˆÙ…`, inline: true },
            { name: 'ÙÙŠ Ù…Ø²Ø±Ø¹ØªÙƒ', value: `**${userQuantity.toLocaleString()}** (Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„: ${income}/ÙŠÙˆÙ…)`, inline: false }
        )
        .setFooter({ text: `Ø§Ù„Ø­ÙŠÙˆØ§Ù† ${itemIndex + 1} Ù…Ù† ${totalItems}` });

    const actionRow1 = new ActionRowBuilder().addComponents(
        new ButtonBuilder().setCustomId(`farm_prev_detail_${item.id}`).setLabel('â—€ï¸').setStyle(ButtonStyle.Secondary),
        new ButtonBuilder().setCustomId(`farm_next_detail_${item.id}`).setLabel('â–¶ï¸').setStyle(ButtonStyle.Secondary),
        new ButtonBuilder().setCustomId('farm_back_to_grid').setLabel('Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±').setStyle(ButtonStyle.Primary)
    );

    const actionRow2 = new ActionRowBuilder().addComponents(
        new ButtonBuilder().setCustomId(`buy_animal_${item.id}`).setLabel('Ø´Ø±Ø§Ø¡').setStyle(ButtonStyle.Success),
        new ButtonBuilder().setCustomId(`sell_animal_${item.id}`).setLabel(`Ø¨ÙŠØ¹ (ØªÙ…Ù„Ùƒ: ${userQuantity})`).setStyle(ButtonStyle.Danger).setDisabled(userQuantity === 0)
    );

    return { embed: detailEmbed, components: [actionRow1, actionRow2] };
}

module.exports = {
    data: new SlashCommandBuilder()
        .setName('Ù…Ø²Ø±Ø¹Ø©')
        .setDescription('ÙŠØ¹Ø±Ø¶ Ù…ØªØ¬Ø± Ø§Ù„Ù…Ø²Ø±Ø¹Ø© Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª.'),

    name: 'farm',
    aliases: ['Ø§Ù„Ù…Ø²Ø±Ø¹Ø©', 'Ù…Ø²Ø±Ø¹Ù‡','Ù…Ø²Ø±Ø¹Ø©', 'Ø­ÙŠÙˆØ§Ù†Ø§Øª'],
    category: "Economy",
    description: 'ÙŠØ¹Ø±Ø¶ Ù…ØªØ¬Ø± Ø§Ù„Ù…Ø²Ø±Ø¹Ø© Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª.',

    async execute(interactionOrMessage, args) {

        const isSlash = !!interactionOrMessage.isChatInputCommand;
        let interaction, message, client, sql, user, guild;

        if (isSlash) {
            interaction = interactionOrMessage;
            client = interaction.client;
            sql = client.sql;
            user = interaction.user;
            guild = interaction.guild;
            await interaction.deferReply();
        } else {
            message = interactionOrMessage;
            client = message.client;
            sql = client.sql;
            user = message.author;
            guild = message.guild;
        }

        const reply = async (payload) => {
            if (isSlash) {
                return interaction.editReply(payload);
            } else {
                return message.channel.send(payload);
            }
        };

        const allItems = farmAnimals;
        if (allItems.length === 0) {
            const embed = new EmbedBuilder().setTitle('ðŸžï¸ Ù…ØªØ¬Ø± Ø§Ù„Ù…Ø²Ø±Ø¹Ø©').setDescription("Ø§Ù„Ù…ØªØ¬Ø± ÙØ§Ø±Øº Ø­Ø§Ù„ÙŠØ§Ù‹.").setColor(Colors.Red);
            return reply({ embeds: [embed] });
        }

        let currentPage = 0;
        let currentView = 'grid'; // 'grid' or 'detail'
        let currentItemIndex = 0;

        const { embed, components } = buildGridView(allItems, currentPage);

        const msg = await reply({ embeds: [embed], components: components, fetchReply: true });

        const filter = i => i.user.id === user.id;
        const collector = msg.createMessageComponentCollector({
            time: 180000,
            filter,
        });

        collector.on('collect', async i => {
            // ðŸ”¥ Ø­Ù…Ø§ÙŠØ©: Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ (Ù…Ù† Ø§Ù„Ù‡Ø§Ù†Ø¯Ù„Ø± Ø§Ù„Ø¹Ø§Ù… Ù…Ø«Ù„Ø§Ù‹)ØŒ Ù†ØªÙˆÙ‚Ù
            if (i.replied || i.deferred) return;

            try {
                // ========================================================
                // 1. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© (Select Menu)
                // ========================================================
                if (i.isStringSelectMenu() && i.customId === 'farm_select_item') {
                    await i.deferUpdate();
                    currentView = 'detail';
                    const selectedID = i.values[0];
                    const item = allItems.find(it => it.id === selectedID);
                    if (item) {
                        currentItemIndex = allItems.findIndex(it => it.id === selectedID);
                        const { embed: detailEmbed, components: detailComponents } = buildDetailView(item, i.user.id, i.guild.id, sql, currentItemIndex, allItems.length);
                        await i.editReply({ embeds: [detailEmbed], components: detailComponents });
                    }
                }
                
                // ========================================================
                // 2. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± (Buttons)
                // ========================================================
                else if (i.isButton()) {

                    // A. Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ (Ø§Ù„Ø³Ø§Ø¨Ù‚/Ø§Ù„ØªØ§Ù„ÙŠ)
                    if (i.customId.startsWith('farm_prev_detail_') || i.customId.startsWith('farm_next_detail_')) {
                        await i.deferUpdate();

                        const currentItemID = i.customId.split('_')[3];
                        currentItemIndex = allItems.findIndex(it => it.id === currentItemID);

                        if (currentItemIndex === -1) currentItemIndex = 0; // Ø­Ù…Ø§ÙŠØ©

                        if (i.customId.startsWith('farm_next_detail_')) {
                            currentItemIndex = (currentItemIndex + 1) % allItems.length;
                        } else {
                            currentItemIndex = (currentItemIndex - 1 + allItems.length) % allItems.length;
                        }

                        const item = allItems[currentItemIndex];
                        const { embed: detailEmbed, components: detailComponents } = buildDetailView(item, i.user.id, i.guild.id, sql, currentItemIndex, allItems.length);
                        await i.editReply({ embeds: [detailEmbed], components: detailComponents });
                    }

                    // B. Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±
                    else if (i.customId === 'farm_back_to_grid') {
                        await i.deferUpdate();
                        currentView = 'grid';
                        const { embed: gridEmbed, components: gridComponents } = buildGridView(allItems, currentPage);
                        await i.editReply({ embeds: [gridEmbed], components: gridComponents });
                    }

                    // C. Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„Ø¨ÙŠØ¹ (Ø§Ù„Ù…ÙˆØ¯Ø§Ù„)
                    else if (i.customId.startsWith('buy_animal_') || i.customId.startsWith('sell_animal_')) {
                        const isBuy = i.customId.startsWith('buy_animal_');
                        const assetId = i.customId.replace(isBuy ? 'buy_animal_' : 'sell_animal_', '');
                        const item = allItems.find(it => it.id === assetId);

                        if (!item) return;

                        const modal = new ModalBuilder()
                            .setCustomId(`${isBuy ? 'buy_animal_' : 'sell_animal_'}${assetId}`)
                            .setTitle(isBuy ? "Ø´Ø±Ø§Ø¡ Ø­ÙŠÙˆØ§Ù†" : "Ø¨ÙŠØ¹ Ø­ÙŠÙˆØ§Ù†");

                        const quantityInput = new TextInputBuilder()
                            .setCustomId('quantity_input')
                            .setLabel(isBuy ? `Ø§Ù„ÙƒÙ…ÙŠØ© (Ø³Ø¹Ø± Ø§Ù„ÙˆØ§Ø­Ø¯: ${item.price})` : `ÙƒÙ…ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹ (Ù„Ø¯ÙŠÙƒ ÙÙŠ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©)`)
                            .setStyle(TextInputStyle.Short)
                            .setPlaceholder('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ø§Ù‹ (Ù…Ø«Ù„Ø§Ù‹: 1)')
                            .setMinLength(1)
                            .setMaxLength(5)
                            .setRequired(true);

                        modal.addComponents(new ActionRowBuilder().addComponents(quantityInput));
                        
                        // ðŸ”¥ Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰)
                        // Ù†Ø³ØªØ®Ø¯Ù… catch Ù„Ù…Ù†Ø¹ Ø§Ù„ÙƒØ±Ø§Ø´ Ø¥Ø°Ø§ Ø³Ø¨Ù‚Ù‡ Ù‡Ø§Ù†Ø¯Ù„Ø± Ø¢Ø®Ø±
                        await i.showModal(modal).catch(err => {
                            if (err.code !== 40060 && err.code !== 10062) {
                                console.error("Modal Error:", err);
                            }
                        });
                    }
                }

            } catch (error) {
                console.error("Farm Collector Error:", error);
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø®ÙÙŠØ© ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… Ù†Ù‚Ù… Ø¨Ø§Ù„Ø±Ø¯ Ø¨Ø¹Ø¯
                if (!i.replied && !i.deferred) {
                    await i.reply({ content: 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹.', ephemeral: true }).catch(() => {});
                }
            }
        });

        collector.on('end', () => {
            if (msg.editable) {
                msg.edit({ components: [] }).catch(() => null);
            }
        });
    }
};
