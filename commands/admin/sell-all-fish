const { SlashCommandBuilder } = require("discord.js");

// ğŸ”’ Ø¢ÙŠØ¯ÙŠÙƒ ÙÙ‚Ø·
const OWNER_ID = "1145327691772481577";

// ğŸ’° Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£Ø³Ù…Ø§Ùƒ (Ù…Ù† Ù…Ù„Ù Ø§Ù„ÙƒÙˆÙ†ÙØ¬ Ø­Ù‚Ùƒ)
const FISH_PRICES = {
    "fish_trash": 1,
    "fish_boot": 2,
    "fish_seaweed": 5,
    "fish_branch": 3,
    "fish_sock": 4,
    "fish_bottle": 20, // Ø£Ø¶ÙØªÙ‡Ø§ Ø§Ø­ØªÙŠØ§Ø·Ø§Ù‹ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©
    "fish_sardine": 10,
    "fish_shrimp": 15,
    "fish_anchovy": 15, // Ø§Ø­ØªÙŠØ§Ø·
    "fish_crab": 20, // Ø§Ø­ØªÙŠØ§Ø·
    "fish_goldfish": 25,
    "fish_tuna": 30,
    "fish_squid": 35,
    "fish_mackerel": 40,
    "fish_seahorse": 45, // Ø§Ø­ØªÙŠØ§Ø·
    "fish_salmon": 60,
    "fish_lobster": 70,
    "fish_clown": 80,
    "fish_octopus": 90,
    "fish_puffer": 120,
    "fish_turtle": 150,
    "fish_ray": 180,
    "fish_shark": 300,
    "fish_dolphin": 350,
    "fish_whale": 400,
    "fish_orca": 450, // Ø§Ø­ØªÙŠØ§Ø·
    "fish_treasure": 600,
    "fish_megalodon": 700, // Ø§Ø­ØªÙŠØ§Ø·
    "fish_kraken": 800,
    "fish_golden_whale": 950,
    "fish_leviathan": 1000 // Ø§Ø­ØªÙŠØ§Ø·
};

module.exports = {
    data: new SlashCommandBuilder()
        .setName('ØªØ¹ÙˆÙŠØ¶-Ø§Ù„Ø³Ù…Ùƒ')
        .setDescription('ØªØ­ÙˆÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø£Ø³Ù…Ø§Ùƒ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¥Ù„Ù‰ Ù…ÙˆØ±Ø§ ÙˆØ­Ø°ÙÙ‡Ø§ Ù…Ù† Ø§Ù„Ø­Ù‚ÙŠØ¨Ø© (Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·).'),

    name: 'sellallfish',
    aliases: ['ØªØ¹ÙˆÙŠØ¶_Ø³Ù…Ùƒ', 'fixfish'],
    category: "Admin",
    description: "ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ùƒ Ø¥Ù„Ù‰ Ù…ÙˆØ±Ø§.",

    async execute(interactionOrMessage, args) {
        const isSlash = !!interactionOrMessage.isChatInputCommand;
        const authorId = isSlash ? interactionOrMessage.user.id : interactionOrMessage.author.id;
        const client = interactionOrMessage.client;
        const sql = client.sql;

        // Ø­Ù…Ø§ÙŠØ©
        if (authorId !== OWNER_ID) return;

        const reply = async (content) => {
            if (isSlash) await interactionOrMessage.reply({ content, ephemeral: true });
            else await interactionOrMessage.reply(content);
        };

        try {
            await reply("â³ Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ùƒ... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.");

            // 1. Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ùƒ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø­Ù‚Ø§Ø¦Ø¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
            const allFishItems = sql.prepare("SELECT * FROM user_portfolio WHERE itemID LIKE 'fish_%'").all();

            if (allFishItems.length === 0) {
                if (isSlash) await interactionOrMessage.editReply("âœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ø£Ø³Ù…Ø§Ùƒ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØ¹ÙˆÙŠØ¶Ù‡Ø§.");
                else await interactionOrMessage.channel.send("âœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ø£Ø³Ù…Ø§Ùƒ.");
                return;
            }

            // 2. ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ù„ÙƒÙ„ Ù„Ø§Ø¹Ø¨
            // Ø§Ù„Ù‡ÙŠÙƒÙ„: { "userID-guildID": totalAmount }
            const refunds = {};

            for (const item of allFishItems) {
                const price = FISH_PRICES[item.itemID] || 5; // Ø³Ø¹Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠ 5 Ù„Ùˆ Ø§Ù„Ø³Ù…ÙƒØ© Ù…Ùˆ Ø¨Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                const totalValue = price * item.quantity;
                const key = `${item.userID}-${item.guildID}`;

                if (!refunds[key]) refunds[key] = 0;
                refunds[key] += totalValue;
            }

            // 3. ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ±Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
            let usersCount = 0;
            let totalMoraDistributed = 0;

            const setLevel = client.setLevel;
            const getLevel = client.getLevel;

            for (const [key, amount] of Object.entries(refunds)) {
                const [userID, guildID] = key.split('-');
                
                // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                let userData = getLevel.get(userID, guildID);
                if (!userData) {
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ù‡ Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ù†Ù†Ø´Ø¦ Ù„Ù‡ ÙˆØ§Ø­Ø¯Ø© (Ù†Ø§Ø¯Ø± Ø§Ù„Ø­Ø¯ÙˆØ« Ù„Ù…Ù† Ù„Ø¯ÙŠÙ‡ Ø³Ù…Ùƒ)
                    userData = { ...client.defaultData, user: userID, guild: guildID };
                }

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº
                userData.mora += amount;
                setLevel.run(userData);

                usersCount++;
                totalMoraDistributed += amount;
            }

            // 4. Ø­Ø°Ù Ø§Ù„Ø£Ø³Ù…Ø§Ùƒ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
            const deleteInfo = sql.prepare("DELETE FROM user_portfolio WHERE itemID LIKE 'fish_%'").run();

            // 5. Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
            const report = `âœ… **ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!**\n` +
                           `ğŸ’° ØªÙ… ØªÙˆØ²ÙŠØ¹: **${totalMoraDistributed.toLocaleString()}** Ù…ÙˆØ±Ø§.\n` +
                           `ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†: **${usersCount}** Ù„Ø§Ø¹Ø¨.\n` +
                           `ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù **${deleteInfo.changes}** Ø³Ø¬Ù„ Ø³Ù…Ùƒ Ù…Ù† Ø§Ù„Ø­Ù‚Ø§Ø¦Ø¨.\n\n` +
                           `âš ï¸ **Ø§Ù„Ø¢Ù† Ù‚Ù… Ø¨Ø­Ø°Ù Ù…Ù„Ù \`sell-all-fish.js\` Ù…Ù† Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨ÙˆØª.**`;

            if (isSlash) await interactionOrMessage.editReply(report);
            else await interactionOrMessage.channel.send(report);

        } catch (error) {
            console.error(error);
            if (isSlash) await interactionOrMessage.editReply("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©. Ø±Ø§Ø¬Ø¹ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„.");
            else await interactionOrMessage.channel.send("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£.");
        }
    }
};
